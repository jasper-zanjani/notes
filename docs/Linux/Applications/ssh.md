# SSH

SSH is a secure protocol and the most common way of remotely administering Linux servers and other equipment.
SSH uses **symmetrical encryption**, which means a single key encrypts outbound messages to and inbound messages from the other participant.

The SSH session is established in two stages:

1. Negotiate session key
2. Authenticate the user

The symmetrical key used for the session, called the **session key**, is negotiated through the asymmetrical [Diffie-Hellman](#diffie-hellman) key exchange protocol.
This algorithm combines private data with public data from the other participant to produce the identical, session key, and the encryption used for the rest of the connection is called **binary packet protocol**.

The simplest and least secure method of authentication is password-based.
Although the password is sent through the encryption, it is still considered vulnerable to brute-force attacks.

SSH **key pairs**, which are asymmetric, are recommended. These are what is generated by [**ssh-keygen**](#ssh-keygen), and stored in **$HOME/.ssh** with names that reflect the encryption algorithm, i.e. "id_rsa" and "id_rsa.pub", etc.
The public key, used to **encrypt** data for the private key, can be freely shared.
In fact, this is the purpose of **ssh-copy-id**, to share the public key.
However the private key, which is used for decryption, must be kept secret.

The client sends an ID for the key pair it wants to authenticate with to the server. The server then checks the **authorized_keys** file of the requested account for the ID.
A random number is generated by the server, encrypted with the public key, and sent to the client.
The client then decrypts the random number and combines it with the shared session key and calculates the MD5 hash.
This hash is then sent back to the server, which checks the calculation.


The SSH server daemon has slightly different names on Debian and Red Hat systems

=== ":material-ubuntu: Ubuntu"

    ```sh
    apt install openssh-server
    service ssh start
    ```

=== ":material-redhat: Red Hat"

    ```sh
    service sshd start
    ```

## Config

#### $HOME/.ssh/config
:   
    ```yaml
    Host home
        HostName 192.168.1.1
        User root
        Port 50022
        SetEnv BAT_THEME=OneHalfLight # (1)
        LocalForward 8080 localhost:8080 # (2)
    ```

    1. **SetEnv** allows environment variables to be set in a remote session. However, these environment variables must be explicitly specified in the server's sshd\_config file.
    This entry will set a specific syntax highlighting theme for use on the bat CLI utility.
    ```ssh
    AllowEnv BAT_THEME
    ```
    2. This is equivalent to the following command:
    ```sh
    ssh -L 8080:localhost:8080 $SERVER
    ```

--8<-- "includes/Linux/Commands/sshd_config.md"

## Tasks

#### Port forwarding
:   
    Port forwarding is accomplished in one of two ways, differentiated by the **origin of the request** not that of the content being served.

    - **Local** (**`-L`**): connections to the client are forwarded through the SSH tunnel to the SSH server. This technique is used to provide functionality similar to a VPN, where remote access is made possible to content on a private network, such as file shares or web applications that are not exposed publicly.
    - **Remote** (**`-R`**)...
    - **Dynamic**

    Here, a private web application served locally on **ssh-server** will be served on the client at the same port.
    The first "localhost" can actually be omitted, since the connection will be exposed on localhost host by default and is almost universally.

    The confusing part is the second "localhost", because that is actually in reference to the ssh server itself.
    ```sh
    ssh -L localhost:80:localhost:80 ssh-server
    ```
    It is actually possible to forward a request to another host on ssh-server's network, creating a jump box.
    Here a connection on the client's localhost:81 is forwarded to ssh-server, which then sends it to 192.168.1.1:80.
    ```sh
    ssh -L 81:192.168.1.1:80 ssh-server
    ```

--8<-- "includes/Linux/Tasks/X-forwarding.md"

## Commands

--8<-- "includes/Linux/Commands/endlessh.md"

--8<-- "includes/Linux/Commands/ssh-copy-id.md"

--8<-- "includes/Linux/Commands/ssh-keygen.md"

